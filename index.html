<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Banco de Cifras</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Seu CSS completo e personalizado vai aqui */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 15px; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #1e1e1e; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid #333; }
        /* ... (cole o resto do seu CSS aqui) ... */
    </style>
</head>
<body>
    <script>
        const API_BASE_URL = "/.netlify/functions/"; // <<<<<<< A URL CORRETA
        const selectMusicas = document.getElementById('musicas-select');
        const displayCifra = document.getElementById('cifra-display');
        const searchInput = document.getElementById('searchInput');
        let todasAsMusicas = [];
        // ... (resto das suas variáveis globais)

        document.addEventListener('DOMContentLoaded', () => {
            const cifrasEmCache = localStorage.getItem('bancoDeCifrasCache_BD');
            if (cifrasEmCache) {
                popularListaDeMusicas(JSON.parse(cifrasEmCache));
            }
            fetch(API_BASE_URL + "getMusicas")
                .then(response => {
                    if (!response.ok) throw new Error("Erro na rede ao buscar dados.");
                    return response.json();
                })
                .then(data => {
                    if (data && Array.isArray(data)) {
                        localStorage.setItem('bancoDeCifrasCache_BD', JSON.stringify(data));
                        popularListaDeMusicas(data);
                    }
                })
                .catch(error => {
                    console.error("Falha ao buscar cifras da internet. Usando cache se disponível.", error);
                });
        });

        function buscarCifra() {
            stopScroll();
            const musicaId = selectMusicas.value;
            if (!musicaId || !todasAsMusicas.length) { /*...*/ return; }
            
            const musica = todasAsMusicas.find(m => m.id == musicaId); // Usar == para comparar número com string
            if (musica && musica.cifra) {
                mostrarCifra(musica);
                return;
            }

            displayCifra.innerHTML = "Carregando cifra...";
            displayCifra.classList.add('loading');
            
            fetch(`${API_BASE_URL}getMusicas?id=${encodeURIComponent(musicaId)}`)
                .then(response => response.json())
                .then(data => {
                    if (musica) {
                        musica.cifra = data.cifra; 
                        localStorage.setItem('bancoDeCifrasCache_BD', JSON.stringify(todasAsMusicas));
                    }
                    mostrarCifra(data);
                })
                .catch(error => {
                    tratarErro({ message: "Você está offline. Esta cifra ainda não foi salva para uso local." });
                });
        }
        
        document.getElementById('novaCifraForm').onsubmit = (event) => {
            event.preventDefault();
            const dadosFormulario = {
                titulo: document.getElementById('inputTitulo').value,
                artista: document.getElementById('inputArtista').value,
                cifraBruta: document.getElementById('inputCifraBruta').value
            };
            // ... (resto da lógica de salvar)
            
            fetch(API_BASE_URL + "adicionarCifra", {
                method: 'POST',
                body: JSON.stringify(dadosFormulario)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'sucesso') {
                    onSaveSuccess(data);
                } else {
                    onSaveFailure({ message: data.error || 'Erro desconhecido.' });
                }
            })
            .catch(error => onSaveFailure(error));
        };
        
        function adicionarOpcaoMusica(musica) {
            const option = document.createElement('option');
            option.value = musica.id; // Agora é um ID numérico
            option.textContent = `${musica.titulo} - ${musica.artista}`;
            selectMusicas.appendChild(option);
        }

        function onSaveSuccess(response) {
            const statusSalvar = document.getElementById('status-salvar');
            if (response.status === "sucesso") {
                statusSalvar.style.color = 'green';
                statusSalvar.textContent = 'Cifra adicionada com sucesso!';
                
                todasAsMusicas.push(response.novaMusica);
                localStorage.setItem('bancoDeCifrasCache_BD', JSON.stringify(todasAsMusicas));
                
                filtrarMusicas();
                // ... (resto da função)
            } else {
                onSaveFailure({ message: response.mensagem || 'Erro desconhecido.' });
            }
        }

        // ... (resto de todas as suas outras funções e event listeners)
    </script>
</body>
</html>